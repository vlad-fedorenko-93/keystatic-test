---
import { getCollection, getEntry, getEntries } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Tag from "../../components/Tag.svelte";
import Button from "../../components/Button.svelte";

// Generate static pages
export async function getStaticPaths() {
  // 1. Fetch ALL posts from the "posts" content collection
  const posts = await getCollection("posts");

  // 2. Return an array of objects, where each object represents a page.
  //    The 'params' object must match the dynamic part of your filename ([slug]).
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { id: posts.indexOf(post) },
  }));
}

// Find specific post
const { slug } = Astro.params;

if (!slug) throw new Error("Slug not found");

// 3. Fetch the specific post entry from the "posts" collection using the slug
const post = await getEntry("posts", slug);

const posts = await getCollection("posts");
const prevPost = !posts[Astro.props.id - 1] ? posts[posts.length - 1] : posts[Astro.props.id - 1];
const nextPost = !posts[Astro.props.id + 1] ? posts[0] : posts[Astro.props.id + 1];

if (!post) throw new Error("No post found for this slug");

// 4. Render the post content into a component
const { Content } = await post.render();
---

<Layout title={post.data.title}>
  <section class="bg-slate-50">
    <div class="relative m-auto w-3/4 flex flex-col py-48">
      <a
        class="absolute top-6 text-md text-slate-500 hover:text-slate-800"
        href="/">Back to home</a
      >
      
      <h1 class="text-6xl font-bold mb-4">{post.data.title}</h1>
      <div>{post.data.tags?.map((tag) => <Tag tag={tag} />)}</div>
    </div>
  </section>
  <section class="m-auto p-40 w-3/4">
    <Content />
  </section>
  <section class="m-auto p-40 w-3/4 grid grid-cols-2 gap-4">
    <Button label={"Previous post"} title={prevPost.data.title} slug={`/posts/${prevPost.slug}`}/>
    <Button label={"Next post"} title={nextPost.data.title} slug={`/posts/${nextPost.slug}`}/>
  </section>
</Layout>

<style>
  div {
    display: flex;
    gap: 0.5rem;
  }
</style>
